# API-521 Fire Exposure Calculations

Complete implementation of API Standard 521 fire exposure calculations for PSV sizing.

## Quick Start

```typescript
import { calculateAPI521FireLoad, ENVIRONMENTAL_FACTORS } from '@/lib/api521';

const result = calculateAPI521FireLoad(
  150.5,  // wetted area (m²)
  420,    // latent heat (kJ/kg)
  ENVIRONMENTAL_FACTORS.BARE,  // no protection
  0       // height above grade (m)
);

console.log(`Relief rate: ${result.reliefRate.toFixed(2)} kg/h`);
```

## Environmental Factors

Per API-521 Table 4.4.1:

| Protection Type | Factor | Description |
|----------------|--------|-------------|
| `BARE` | 1.0 | Bare steel vessel, no protection |
| `INSULATED` | 0.3 | 50-100mm insulation |
| `WATER_SPRAY` | 0.15 | Water spray or deluge system |
| `INSULATED_WITH_WATER` | 0.075 | Insulated + water spray |
| `BURIED` | 0.0 | Buried or underground |

## API Functions

### `calculateAPI521FireLoad`

Complete fire sizing calculation.

```typescript
const result = calculateAPI521FireLoad(
  wettedArea: number,         // m²
  latentHeat: number,         // kJ/kg
  environmentalFactor: number = 1.0,
  heightAboveGrade: number = 0  // m
);

// Returns:
{
  wettedArea: number;          // Original wetted area
  limitedWettedArea: number;   // Limited to 7.6m height
  heatAbsorption: number;      // W
  reliefRate: number;          // kg/h
  environmentalFactor: number;
}
```

### `calculateFireHeatAbsorption`

Just the heat absorption calculation.

```typescript
const Q = calculateFireHeatAbsorption(
  wettedArea: number,           // m²
  environmentalFactor: number = 1.0
);  
// Returns heat absorption in Watts
```

### `calculateFireReliefRate`

Convert heat absorption to relief rate.

```typescript
const reliefRate = calculateFireReliefRate(
  heatAbsorption: number,  // W
  latentHeat: number       // kJ/kg
);
// Returns kg/h
```

### `validateFireSizingInputs`

Validate inputs before calculation.

```typescript
const validation = validateFireSizingInputs(
  wettedArea: number,
  latentHeat: number,
  environmentalFactor: number
);

if (!validation.valid) {
  console.error('Validation errors:', validation.errors);
}
```

## Integration with Vessel Calculations

```typescript
import { calculateFireExposureArea } from '@/lib/vesselCalculations';
import { calculateAPI521FireLoad, ENVIRONMENTAL_FACTORS } from '@/lib/api521';

// Get wetted area from vessel geometry
const wettedArea = calculateFireExposureArea(
  {
    vesselType: 'vertical-torispherical',
    diameter: 3.5,
    length: 10.0,
    liquidLevel: 6.5
  },
  false  // not protected
);

// Calculate fire relief load
const fireLoad = calculateAPI521FireLoad(
  wettedArea,
  420,  // latent heat of propane
  ENVIRONMENTAL_FACTORS.BARE
);

console.log(`Fire relief: ${fireLoad.reliefRate.toFixed(0)} kg/h`);
```

## Standard Formula

The API-521 fire exposure formula is:

```
Q = 21,000 × F × A^0.82  (Watts)
```

Where:
- **Q** = Heat absorption rate (W)
- **F** = Environmental factor (dimensionless)
- **A** = Wetted surface area (m²)

**Note**: The wetted surface area is limited to 7.6m (25 ft) above grade or above the highest probable liquid level.

## Validation Rules

The module validates:
- ✅ Wetted area > 0
- ✅ Wetted area ≤ 2,800 m² (API-521 recommended maximum)
- ✅ Latent heat > 0
- ✅ Latent heat between 50-2500 kJ/kg (typical range)
- ✅ Environmental factor between 0 and 1

## Example: Complete Fire Case

```typescript
import { calculateFireExposureArea } from '@/lib/vesselCalculations';
import {
  calculateAPI521FireLoad,
  ENVIRONMENTAL_FACTORS,
  validateFireSizingInputs,
  getEnvironmentalFactorDescription
} from '@/lib/api521';

function sizeFireRelief(scenario: {
  vesselDiameter: number;
  vesselLength: number;
  liquidLevel: number;
  fluidLatentHeat: number;
  hasInsulation: boolean;
  hasWaterSpray: boolean;
}) {
  // Get wetted area
  const wettedArea = calculateFireExposureArea(
    {
      vesselType: 'vertical-torispherical',
      diameter: scenario.vesselDiameter,
      length: scenario.vesselLength,
      liquidLevel: scenario.liquidLevel
    },
    scenario.hasInsulation || scenario.hasWaterSpray
  );

  // Determine environmental factor
  let envFactor = ENVIRONMENTAL_FACTORS.BARE;
  if (scenario.hasInsulation && scenario.hasWaterSpray) {
    envFactor = ENVIRONMENTAL_FACTORS.INSULATED_WITH_WATER;
  } else if (scenario.hasWaterSpray) {
    envFactor = ENVIRONMENTAL_FACTORS.WATER_SPRAY;
  } else if (scenario.hasInsulation) {
    envFactor = ENVIRONMENTAL_FACTORS.INSULATED;
  }

  // Validate
  const validation = validateFireSizingInputs(
    wettedArea,
    scenario.fluidLatentHeat,
    envFactor
  );

  if (!validation.valid) {
    throw new Error(`Invalid inputs: ${validation.errors.join(', ')}`);
  }

  // Calculate
  const result = calculateAPI521FireLoad(
    wettedArea,
    scenario.fluidLatentHeat,
    envFactor
  );

  return {
    wettedArea: result.wettedArea,
    protectionType: getEnvironmentalFactorDescription(envFactor),
    heatAbsorption: result.heatAbsorption / 1000,  // kW
    reliefRate: result.reliefRate,  // kg/h
  };
}
```

## References

- API Standard 521, "Pressure-relieving and Depressuring Systems", 6th Edition
- Section 4.4 - Fire Exposure
- Table 4.4.1 - Environmental Factors
